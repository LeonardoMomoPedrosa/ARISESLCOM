@model ARISESLCOM.Models.Entities.TrackingModel
@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <style>
        #orderNotFoundModal.fade {
            transition: opacity 0.001s linear;
        }
        #orderNotFoundModal.show {
            opacity: 1;
        }
        #orderNotFoundModal.modal.fade .modal-dialog {
            transition: transform 0.001s ease-out;
        }
        #orderNotFoundModal.modal.show .modal-dialog {
            transform: none;
        }
    </style>
    <script>
        function carregarRastreamento(codigoRastreamento) {
            const modalBody = document.getElementById('rastreamentoModalBody');
            if (!modalBody) {
                return;
            }

            modalBody.innerHTML = `
                <div class="text-center py-2">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 mb-0 small">Carregando informações de rastreamento...</p>
                </div>
            `;

            fetch(`/Order/GetRastreamento/${codigoRastreamento}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao buscar rastreamento');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.objetos && data.objetos.length > 0) {
                        const objeto = data.objetos[0];
                        let html = `
                            <div class="mb-2">
                                <h6 class="mb-1">Código: <strong>${objeto.codObjeto}</strong></h6>
                                ${objeto.tipoPostal ? `<p class="mb-1 small text-muted">${objeto.tipoPostal.descricao}</p>` : ''}
                                ${objeto.dtPrevista ? `<p class="mb-0 small text-muted">Previsão: ${new Date(objeto.dtPrevista).toLocaleDateString('pt-BR')}</p>` : ''}
                            </div>
                            <hr class="my-2">
                            <h6 class="mb-2 small fw-bold">Eventos do Rastreamento</h6>
                            <div class="timeline">
                        `;

                        if (objeto.eventos && objeto.eventos.length > 0) {
                            objeto.eventos.forEach((evento, index) => {
                                const dataEvento = new Date(evento.dtHrCriado).toLocaleString('pt-BR');
                                const unidadeInfo = evento.unidade ?
                                    `${evento.unidade.endereco ? evento.unidade.endereco.cidade : ''}${evento.unidade.endereco && evento.unidade.endereco.uf ? '/' + evento.unidade.endereco.uf : ''}` : '';

                                html += `
                                    <div class="card mb-2 rounded-2 ${index === 0 ? 'border-primary border-2' : ''}">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1 small fw-semibold">${evento.descricao}</h6>
                                                    ${evento.detalhe ? `<p class="card-text text-muted mb-1 small">${evento.detalhe}</p>` : ''}
                                                    <p class="card-text mb-0 small text-muted"><i class="bi bi-clock"></i> ${dataEvento}</p>
                                                    ${unidadeInfo ? `<p class="card-text mb-0 small text-muted"><i class="bi bi-geo-alt"></i> ${unidadeInfo}</p>` : ''}
                                                </div>
                                                ${index === 0 ? '<span class="badge bg-primary small">Mais Recente</span>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            html += '<p class="text-muted small mb-0">Nenhum evento encontrado.</p>';
                        }

                        html += '</div>';
                        modalBody.innerHTML = html;
                    } else {
                        modalBody.innerHTML = '<p class="text-muted small mb-0">Nenhuma informação de rastreamento encontrada.</p>';
                    }
                })
                .catch(error => {
                    modalBody.innerHTML = `
                        <div class="alert alert-danger py-2 rounded-2" role="alert">
                            <h6 class="alert-heading small mb-1">Erro ao buscar rastreamento</h6>
                            <p class="mb-0 small">${error.message}</p>
                        </div>
                    `;
                });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const modalElement = document.getElementById('rastreamentoModal');
            if (modalElement) {
                modalElement.addEventListener('hidden.bs.modal', function () {
                    const modalBody = document.getElementById('rastreamentoModalBody');
                    if (modalBody) {
                        modalBody.innerHTML = '';
                    }
                });
            }

            // Gerenciar mudança de origem do rastreamento
            const sourceEcommerce = document.getElementById('sourceEcommerce');
            const sourceERP = document.getElementById('sourceERP');
            const orderIdInput = document.getElementById('orderIdInput');
            const trackNoInput = document.getElementById('trackNoInput');

            function updatePlaceholderAndClearFields(source) {
                if (orderIdInput) {
                    orderIdInput.value = '';
                    orderIdInput.placeholder = source === 'E' ? 'Pedido do site' : 'Pedido do Lion';
                }
                if (trackNoInput) {
                    trackNoInput.value = '';
                }
            }

            if (sourceEcommerce) {
                sourceEcommerce.addEventListener('change', function () {
                    if (this.checked) {
                        updatePlaceholderAndClearFields('E');
                    }
                });
            }

            if (sourceERP) {
                sourceERP.addEventListener('change', function () {
                    if (this.checked) {
                        updatePlaceholderAndClearFields('L');
                    }
                });
            }

            // Limpar campos após envio bem-sucedido
            @if (ViewBag.Success != null && ViewBag.Success == true)
            {
                <text>
                if (orderIdInput) {
                    orderIdInput.value = '';
                }
                if (trackNoInput) {
                    trackNoInput.value = '';
                }
                // Limpar radio buttons de Via
                var viaRadios = document.querySelectorAll('input[name="Via"]');
                viaRadios.forEach(function(radio) {
                    radio.checked = false;
                });
                </text>
            }
        });
    </script>
}
<div class="container">
    <div class="row">
        <nav class="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Rastreamento</li>
            </ol>
        </nav>
    </div>
    <div class="row bg-light border">
        <h5 class="mb-3">Rastreamento</h5>
        <form method="post" asp-controller="Order" asp-action="SaveTracking">
            <div class="row mt-2">
                <div class="col-12 mb-2">
                    <label class="form-label small fw-semibold">Origem do Rastreamento:</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input type="radio" class="form-check-input" asp-for="Source" value="E" id="sourceEcommerce" checked />
                            <label class="form-check-label" for="sourceEcommerce">E-Commerce</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" asp-for="Source" value="L" id="sourceERP" />
                            <label class="form-check-label" for="sourceERP">ERP (Lion)</label>
                        </div>
                    </div>
                    <span asp-validation-for="Source" class="text-danger text-sm"></span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-2">
                    <input type="number" placeholder="Pedido do site" asp-for="OrderId" id="orderIdInput" class="form-control form-control-sm" />
                    <span asp-validation-for="OrderId" class="text-danger text-sm"></span>
                </div>
                <div class="col-3">
                    <input type="text" placeholder="Num. do Rastreamento" asp-for="TrackNo" id="trackNoInput" class="form-control form-control-sm" />
                    <span asp-validation-for="TrackNo" class="text-danger text-sm"></span>
                </div>
                <div class="col-auto">
                    <input type="radio" class="form-check-input" asp-for="Via" value="V" />
                    <label class="form-check-label" for="jad">JAD</label>
                </div>
                <div class="col-auto">
                    <input type="radio" class="form-check-input" asp-for="Via" value="G" />
                    <label class="form-check-label" for="gol">GOL</label>
                </div>
                <div class="col-auto">
                    <input type="radio" class="form-check-input" asp-for="Via" value="B" />
                    <label class="form-check-label" for="bus">BUS</label>
                </div>
                <div class="col-auto">
                    <input type="radio" class="form-check-input" asp-for="Via" value="C" />
                    <label class="form-check-label" for="jad">CORREIOS</label>
                    <span asp-validation-for="Via" class="text-danger text-sm"></span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-auto">
                    <input type="submit" class="btn btn-sm btn-primary" value="Enviar" />
                </div>
            </div>
        </form>
        <br />
        <span class="@(ViewBag.Success != null && ViewBag.Success ? "text-primary" : "text-danger")">@Html.Raw(ViewBag.Result)</span>
        <br />
        <br />
        @{
            var trackingHistory = ViewBag.TrackingHistory as List<ARISESLCOM.Models.Entities.TrackingModel> ?? new List<ARISESLCOM.Models.Entities.TrackingModel>();
        }

        <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Histórico de Rastreamentos (últimos 7 dias)</h6>
                <span class="text-muted small">@DateTime.Now.ToString("dd/MM/yyyy HH:mm")</span>
            </div>

            @if (trackingHistory.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-bordered align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center">Pedido</th>
                                <th>Código de Rastreamento</th>
                                <th class="text-center">Origem</th>
                                <th class="text-center">Via</th>
                                <th class="text-center">Data/Hora</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var tracking in trackingHistory)
                            {
                                <tr>
                                    @{
                                        var viaDescription = TrackingHelper.GetViaDescription(tracking.Via);
                                        var viaStyle = TrackingHelper.GetViaStyle(tracking.Via);
                                        var viaIconColor = TrackingHelper.GetViaIconColor(tracking.Via);
                                        var sourceDescription = TrackingHelper.GetSourceDescription(tracking.Source);
                                        var sourceBadgeStyle = TrackingHelper.GetSourceBadgeStyle(tracking.Source);
                                    }
                                    <td class="text-center fw-semibold">@tracking.OrderId</td>
                                    <td class="font-monospace">
                                        @tracking.TrackNo
                                        @if (tracking.Via == "C" && !string.IsNullOrWhiteSpace(tracking.TrackNo))
                                        {
                                            <i class="bi bi-airplane-fill ms-2"
                                               style="cursor: pointer; color: @viaIconColor; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;"
                                               data-bs-toggle="modal"
                                               data-bs-target="#rastreamentoModal"
                                               data-track="@tracking.TrackNo"
                                               onclick="carregarRastreamento('@tracking.TrackNo')"
                                               title="Rastrear pedido"></i>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="@sourceBadgeStyle">@sourceDescription</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge" style="@viaStyle">@viaDescription</span>
                                    </td>
                                    <td class="text-center text-muted">@tracking.InsertedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-secondary py-2" role="alert">
                    Nenhum rastreamento registrado nos últimos 7 dias.
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal de Rastreamento -->
<div class="modal fade" id="rastreamentoModal" tabindex="-1" aria-labelledby="rastreamentoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content rounded-3">
            <div class="modal-header pb-2">
                <h5 class="modal-title" id="rastreamentoModalLabel">Rastreamento de Encomenda</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-2" id="rastreamentoModalBody">
                <div class="text-center py-2">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 mb-0 small">Carregando informações de rastreamento...</p>
                </div>
            </div>
            <div class="modal-footer pt-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pedido Não Encontrado -->
<div class="modal fade" id="orderNotFoundModal" tabindex="-1" aria-labelledby="orderNotFoundModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-3">
            <div class="modal-header pb-2">
                <h5 class="modal-title" id="orderNotFoundModalLabel">Pedido Não Encontrado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-2">
                <div class="alert alert-warning mb-0" role="alert">
                    <p class="mb-0">
                        <strong>O pedido #<span id="orderNotFoundId"></span> não foi encontrado <span id="orderNotFoundSource"></span>.</strong>
                    </p>
                    <p class="mt-2 mb-0 small" id="orderNotFoundMessage">
                        Verifique se o número do pedido está correto.
                    </p>
                </div>
            </div>
            <div class="modal-footer pt-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

@if (ViewBag.ShowOrderNotFoundModal == true)
{
    <script>
        function showOrderNotFoundModal() {
            var orderNotFoundModalElement = document.getElementById('orderNotFoundModal');
            if (!orderNotFoundModalElement || typeof bootstrap === 'undefined' || !bootstrap.Modal) {
                setTimeout(showOrderNotFoundModal, 10);
                return;
            }
            
            var orderIdElement = document.getElementById('orderNotFoundId');
            var orderNotFoundSourceElement = document.getElementById('orderNotFoundSource');
            var orderNotFoundMessageElement = document.getElementById('orderNotFoundMessage');
            
            if (orderIdElement) {
                orderIdElement.textContent = '@(ViewBag.OrderIdNotFound ?? "")';
            }
            
            var sourceNotFound = '@(ViewBag.SourceNotFound ?? "L")';
            if (orderNotFoundSourceElement) {
                if (sourceNotFound === 'E') {
                    orderNotFoundSourceElement.textContent = 'no E-Commerce';
                    if (orderNotFoundMessageElement) {
                        orderNotFoundMessageElement.textContent = 'Verifique se o número do pedido está correto e se o pedido realmente existe no banco de dados.';
                    }
                } else {
                    orderNotFoundSourceElement.textContent = 'no ERP-Lion';
                    if (orderNotFoundMessageElement) {
                        orderNotFoundMessageElement.textContent = 'Verifique se o número do pedido está correto e se o pedido realmente existe no sistema ERP.';
                    }
                }
            }
            
            var orderNotFoundModal = new bootstrap.Modal(orderNotFoundModalElement, {
                backdrop: true,
                keyboard: true,
                focus: true
            });
            
            orderNotFoundModal.show();
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showOrderNotFoundModal);
        } else {
            showOrderNotFoundModal();
        }
    </script>
}